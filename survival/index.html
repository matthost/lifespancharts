<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survival Chart Comparison</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <h1>Survival Chart Comparison</h1>
    <label for="groupSelect">Select Group to Compare with Control:</label>
    <select id="groupSelect"></select>
    <canvas id="survivalChart" width="800" height="400"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const csvFiles = [
                "itp_data/ITP_C2004_Lifespan.csv", "itp_data/ITP_C2005_Lifespan.csv", "itp_data/ITP_C2006_Lifespan.csv", 
                "itp_data/ITP_C2007_Lifespan.csv", "itp_data/ITP_C2009_Lifespan.csv", "itp_data/ITP_C2010_Lifespan.csv", 
                "itp_data/ITP_C2011_Lifespan.csv", "itp_data/ITP_C2012_Lifespan.csv", "itp_data/ITP_C2013_Lifespan.csv", 
                "itp_data/ITP_C2014_Lifespan.csv", "itp_data/ITP_C2015_Lifespan.csv", "itp_data/ITP_C2016_Lifespan.csv", 
                "itp_data/ITP_C2017_Lifespan.csv", "itp_data/ITP_C2018_Lifespan.csv", "itp_data/ITP_C2019_Lifespan.csv", 
                "itp_data/ITP_C2020_Lifespan.csv"
            ];
            
            const controlGroup = "Control";
            let allData = new Map(); // Store data by file
            let groupToFile = new Map(); // Map groups to their source files

            // Load all files and process data
            Promise.all(csvFiles.map(file => 
                d3.csv(`../${file}`).then(data => ({file, data}))
            )).then(results => {
                results.forEach(({file, data}) => {
                    allData.set(file, data);
                    
                    // Map each group to its source file
                    data.forEach(row => {
                        if (row.group !== controlGroup) {
                            groupToFile.set(row.group, file);
                        }
                    });
                });

                // Populate group select with all unique groups
                updateGroupSelect();
            });

            function updateGroupSelect() {
                const groupSelect = document.getElementById('groupSelect');
                const uniqueGroups = [...groupToFile.keys()].sort();
                
                uniqueGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = `${group} (${groupToFile.get(group).split('/').pop().replace('_Lifespan.csv', '')})`;
                    groupSelect.appendChild(option);
                });

                // Draw initial chart with first group
                if (uniqueGroups.length > 0) {
                    updateChart(uniqueGroups[0]);
                }
            }

            document.getElementById('groupSelect').addEventListener('change', () => {
                const selectedGroup = document.getElementById('groupSelect').value;
                if (selectedGroup) {
                    updateChart(selectedGroup);
                }
            });

            function updateChart(group) {
                // Get the file containing this group
                const sourceFile = groupToFile.get(group);
                const data = allData.get(sourceFile);
                if (!data) return;

                // Filter data by group, sex, and age
                const filterData = (group, sex) => {
                    return data.filter(d => d.group === group && d.sex === sex && !isNaN(parseInt(d['age(days)'])));
                };

                const controlDataMale = filterData(controlGroup, 'm');
                const controlDataFemale = filterData(controlGroup, 'f');
                const selectedGroupDataMale = filterData(group, 'm');
                const selectedGroupDataFemale = filterData(group, 'f');

                // Calculate survival percentage over time
                function calculateSurvival(data) {
                    const deathsByAge = new Map();
                    const ages = data.map(d => parseInt(d['age(days)'])).filter(age => !isNaN(age));

                    ages.forEach(age => {
                        deathsByAge.set(age, (deathsByAge.get(age) || 0) + 1);
                    });

                    const uniqueAges = Array.from(deathsByAge.keys()).sort((a, b) => a - b);
                    const total = data.length;
                    let remaining = total;
                    let survivalPoints = [{ x: 0, y: 100 }];

                    uniqueAges.forEach(age => {
                        const deaths = deathsByAge.get(age);
                        remaining -= deaths;
                        survivalPoints.push({ x: age, y: (remaining / total) * 100 });
                    });

                    return survivalPoints;
                }

                const controlSurvivalMale = calculateSurvival(controlDataMale);
                const controlSurvivalFemale = calculateSurvival(controlDataFemale);
                const groupSurvivalMale = calculateSurvival(selectedGroupDataMale);
                const groupSurvivalFemale = calculateSurvival(selectedGroupDataFemale);

                // Update chart
                const ctx = document.getElementById('survivalChart').getContext('2d');
                if (window.survivalChartInstance) {
                    window.survivalChartInstance.destroy();
                }
                
                const studyYear = sourceFile.split('/').pop().replace('_Lifespan.csv', '');
                
                window.survivalChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: `Control Male (${studyYear})`,
                                data: controlSurvivalMale,
                                borderColor: 'lightblue',
                                fill: false,
                                pointRadius: 0,
                                stepped: true,
                                tension: 0
                            },
                            {
                                label: `Control Female (${studyYear})`,
                                data: controlSurvivalFemale,
                                borderColor: 'pink',
                                fill: false,
                                pointRadius: 0,
                                stepped: true,
                                tension: 0
                            },
                            {
                                label: `${group} Male`,
                                data: groupSurvivalMale,
                                borderColor: 'blue',
                                fill: false,
                                pointRadius: 0,
                                stepped: true,
                                tension: 0
                            },
                            {
                                label: `${group} Female`,
                                data: groupSurvivalFemale,
                                borderColor: 'red',
                                fill: false,
                                pointRadius: 0,
                                stepped: true,
                                tension: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Days'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '% Survival'
                                },
                                min: 0,
                                max: 100
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `${group} vs Control (${studyYear})`
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>